<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

</head>

<body>
<h1 class="ml-3 mt-2"> Dashboard Admin </h1>

<form class="form-horizontal" action="/delete" method="post"  id="eliminaQuestionario" >
<div id="container-input_1"></div>
</form>


<form class="form-horizontal" action="/attivaQuestionario" method="post"  id="attivaQuestionario" >
<div id="container-input"></div>
</form>


<form class="form-horizontal" action="/aggiungiQuestionarioAdmin" method="post"  id="formtest" ></form>


<h5><a href="/aggiungiQuestionario" class="ml-3">Crea un questionario</a></h5>

<h1 class="mt-3 mb-3 ml-3">Lista questionari </h1>



	<div class="container-fluid">		        
    <div id="contenitori-questionari" class="row flex-row flex-nowrap mt-4"></div>
    
    		        
   			</div>
   			</div>


<th:block th:each="domandeQuestionario,iter : ${domandeQuestionario}">
		                      <!-- da qui ciclo for per le domande  -->
		                   <div th:class="|${domandeQuestionario.getquestionariAdmin().idquestionariAdmin}|">


		                     <td> <h6 th:class="|card-text Domanda:${domandeQuestionario.iddomanda}|" th:text="|◉ ${domandeQuestionario.testo}|"></h6></td>


		                    </div>
						</th:block>  


		   			
		     			
		 <th:block th:each="questionariAdmin,iter: ${questionariAdmin}">
		 
		 <td> <input type="text" class="questionari_id" th:value="${questionariAdmin.idquestionariAdmin}"></td>
	
           <td>  <h3 th:id="|titolo${questionariAdmin.idquestionariAdmin}|" class="titoli-questionari" th:text="|${questionariAdmin.titolo}|"></h3></td>
		
	</th:block>  

					
   		
   

<h2 class="ml-3">Voti </h2>
   			
   <div class="">
<th:block th:each="media : ${media}">
<td><h2 class="mt-3 ml-3" th:text="|${media} / 5|"></h2></td>
				</th:block>  

   </div>
   
   
 <!--  <div class="">
   <h2> Il numero totale di voti lasciati è : <span id="totale_voti"></span></h2>
   
</div> --> 
 

    
    <!-- INSERIMENTO DEL NUMERO DI RECENSORI PER OGNI STELLA   -->
		<th:block th:each="stelle1 : ${stelle1}">
		 <div th:if="${stelle1 != null}">
		<td><span id="1"  class="numero-recensori" th:text="|${stelle1}"></span></td>
		
		</th:block>  
		
		
		
		<th:block th:each="stelle2 : ${stelle2}">
		
		<td><span id="2"  class="numero-recensori" th:text="|${stelle2}"></span></td>
		
		</th:block>  
		
		<th:block th:each="stelle3 : ${stelle3}">
		
		<td><span id="3"  class="numero-recensori" th:text="|${stelle3}"></span></td>
		
		</th:block>  
		
		<th:block th:each="stelle4 : ${stelle4}">
		
		<td><span id="4"  class="numero-recensori" th:text="|${stelle4}"></span></td>
		
		</th:block>  
		
		<th:block th:each="stelle5 : ${stelle5}">
		
		<td><span id="5"  class="numero-recensori" th:text="|${stelle5}"></span></td>
		
		</th:block>  


<!--  
<span id="4" class="numero-recensori">800</span>
<span id="3" class="numero-recensori">600</span>
<span id="2" class="numero-recensori">400</span>
<span id="1" class="numero-recensori">200</span>
-->


    <div id="items" class="form-group ml-3 mt-4 container">
    <div class="row">
    <div id="contenitore-stelle" class="col"></div>
    <div id="contenitore-grafico"class="col">
        <canvas id="myChart" style="width:100%;max-width:600px"></canvas>
    </div>
    </div>
</div>





<th:block th:each="domandeQuestionario,iter : ${domandeQuestionario}">
		                      <!-- da qui ciclo for per le domande  -->
		                   <div th:id="|Domanda:${domandeQuestionario.iddomanda}|">
		                   <td><h3 class="NumeroIndiceDomanda" th:text="${domandeQuestionario.iddomanda}" ></h3></td>
		                     <td> <h4 th:class="|card-text|" th:text="|${iter.index+1}) ${domandeQuestionario.testo}|"></h4></td>
		                    </div>
						</th:block>  

<div id="valutazioneDomande">

		<th:block th:each="numeroRisposte : ${numeroRisposte}">
	<div th:class="|idDomanda${numeroRisposte.getdomanda().iddomanda}|">
	  <td> <h6 th:name="|questionarioRelativo:${numeroRisposte.getquestionario().idquestionario}|" class="card-text" th:text="|${numeroRisposte.voto}|"></h6></td>
		  </div>
		
		
		</th:block>
</div>

<div class="mt-2 mb-2 ml-3">
<h2>Valutazioni Domande</h2>
</div>

	      <div class="container-fluid">		        
      <div id="domandeErisposteContenitore" class="row flex-row flex-nowrap mt-4">

      </div>
    </div>
    
    
 <div class="ml-3 mt-4">
 <h1>Questionari compilati dagli utenti</h1>
 </div>
    
   <table class="table mt-3">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">idUtente</th> 
            <th scope="col">Nome</th>
            <th scope="col">Cognome</th>
           <th scope="col">Data</th>
            <th scope="col">idQuestionario Admin</th>
           <th scope="col">Nome Questionario</th>
           <th scope="col">idQuestionario Utente</th>
           <th scope="col">Valutazione media</th>

          </tr>
        </thead>
        <tbody>
 <th:block th:each="questionari,iter  : ${questionari}">
 
          <tr>
            <td scope="row"><h5 th:text="|${iter.index}|"></h5></td>
            <td th:text="${questionari.getutente().idutente}"></td>
            <td th:text="${questionari.getutente().nome}"></td>
            <td th:text="${questionari.getutente().cognome}"></td>
           <td th:text="${#temporals.format(questionari.getdata(),'dd/MM/yyyy HH:mm:ss')}"></td>
           <td th:text="${questionari.getQuestionariAdmin().idquestionariAdmin}"></td>
            <td th:text="${questionari.getQuestionariAdmin().titolo}"></td>
          <td th:text="${questionari.idquestionario}"></td> 
           <td><div class="Divmedia" th:id="|${questionari.idquestionario}|" >
           <td>
           
          </tr>
          
        </tbody>
      </table>
      </th:block>

        <script>
        
        let titoli_questionari=document.getElementsByClassName("titoli-questionari");
        let numeroquestionari=titoli_questionari.length;
        let i = 0;
        let contenitoriQuestionari = document.getElementById(
          "contenitori-questionari"
        );
        let id_questionari= document.getElementsByClassName("questionari_id");
        console.log(id_questionari[0].value);
        

        function PosizionaDomanda(numeroquestionari) {
          while (i < numeroquestionari) {

            console.log("Questionario #" + id_questionari[i].value);
            let div = document.createElement("div");
            div.setAttribute("id", "q" + id_questionari[i].value);
            div.setAttribute("class", "col-5");

            let div1 = document.createElement("div");
            div1.setAttribute("class", "card");

            let div2 = document.createElement("div");
            div2.setAttribute("class", "card-body");

            let div3 = document.createElement("div");
            div3.setAttribute("id", "titolo-q"+id_questionari[i].value);

            titoloQuestionario=document.getElementById("titolo"+id_questionari[i].value);

            let divContenitoreDomande = document.createElement("div");
            divContenitoreDomande.setAttribute("id", "domande" + id_questionari[i].value);

            let domande = document.getElementsByClassName(id_questionari[i].value);
            console.log("Numero domande: " + domande.length);

            // append di tutti i div per la creazione del modello 

            contenitoriQuestionari.append(div);
            div.append(div1);
            div1.append(div2);
            div2.append(div3);
            div3.append(titoloQuestionario);
            div2.append(divContenitoreDomande);

            for (let b = 0; b < domande.length;b++ ) {
              divContenitoreDomande.append(domande[b]);
            }

            let div_bottoni = document.createElement("div");
            div_bottoni.setAttribute("class","d-flex text-white mt-3");

            let bottone_attiva= document.createElement("a");

            bottone_attiva.setAttribute("style", "background-color: rgb(64, 125, 3) !important;");
            //bottone_attiva.setAttribute("class", "button-elimina");
          	bottone_attiva.setAttribute("onclick", "AttivaForm("+id_questionari[i].value+")");
            bottone_attiva.setAttribute("class", "btn btn-primary btn-lg ml-3");

            let bottone_elimina= document.createElement("a");
            bottone_elimina.setAttribute("class", "btn btn-danger btn-lg ml-3");
            bottone_elimina.setAttribute("onclick", "EliminaForm("+id_questionari[i].value+")");


            bottone_attiva.innerHTML="Attiva";
            bottone_elimina.innerHTML="Elimina";
            
            div2.append(div_bottoni);
            div_bottoni.append(bottone_attiva);
            div_bottoni.append(bottone_elimina);

            i += 1;
            
          }
        }
   
            function GeneraStella(parametro){
                let i=0;
                let div_totale= document.getElementById("contenitore-stelle");
                let numero_recensioni=document.getElementById(parametro);
                console.log(numero_recensioni);
            
                // creo un div per ogni gruppo di stelle
                odv = document.createElement('div');
                odv.setAttribute("class", "Div-stelle");
            
                while (i<parametro){
                    // creo il numero di stelle che mi serve ogni volta che richiamo la funzione
                    stella = document.createElement('span');
                    stella.setAttribute("class", "fa fa-star checked");
                    odv.append(stella);
                    i+=1;
                }
                
                odv.append(numero_recensioni);
                div_totale.append(odv);

            	
                console.log(numero_recensioni);
                // le appendo al div creato in precedenza
               /* if(numero_recensioni!=null){
                odv.append(numero_recensioni);
                }else{
                	numero_recensioni.innerHTML="0";
                    odv.append(numero_recensioni);

                }
                div_totale.append(odv);*/
            
            }
            
            function CreaGrafico(){
            var yValues = [];
            var Valutazioni=document.getElementsByClassName("numero-recensori");
            for (let index = 0; index < Valutazioni.length; index++) {
                yValues.push(Valutazioni[index].textContent);
            }
            var xValues = ["5 stelle", "4 stelle", "3 stelle", "2 stelle", "1 stella",""];
            var barColors = ["brown","red", "green","blue","orange","brown"];
            yValues.push("0");

            new Chart("myChart", {
              type: "bar",
              data: {
                labels: xValues,
                datasets: [{
                  backgroundColor: barColors,
                  data: yValues
                }]
              },
              options: {
                legend: {display: false},
                title: {
                  display: true,
                  text: "Recensioni "
                }
              }
            })
            }
            
          
            function PosizionaDomandaeRisposte(){

            	//inizializzo le variabile 
            	  let counter=0;
            	  let zero=0;
            	  let uno=0;
            	  let due=0;
            	  let tre = 0; 
            	  let quattro = 0;
            	  let cinque =0;
            	  let totale_voti=0;

            	  // prendo tutte le domande 
            	  const last = Array.from(
            	    document.querySelectorAll('.NumeroIndiceDomanda')
            	  );

            	  // recupero il numero della prima e ultima domanda
            	  min = last[0].textContent;
            	  max = last[last.length-1].textContent;

            	  console.log("il valore minimo è: "+last[0].textContent); // 👉️ "min"
            	  console.log("il valore massimo è: "+last.pop().textContent); // 👉️ "max"

            	  // converto le stringhe in numeri
            	  min = +min;
            	  max= +max;

            	  while(min<=max){
            	    // inizializzo le variabili che utilizzerò nel ciclo
            	      console.log("entrato nel ciclo")
            	      somma=0;
            	      media=0;
            	      b=0;

            	      // queste variabili le utilizzo per tenere conto di quante persone hanno votato un certo numero di stelle
            	      uno=0;
            	      due=0;
            	      tre=0;
            	      quattro=0;
            	      cinque=0;


            	      // recupero il contenitore che terrà tutte le risposte
            	      divDomandeRisposteContenitore=document.getElementById("domandeErisposteContenitore");


            	      // verifico se la domanda esiste
            	      if(document.getElementById("Domanda:"+min)!=null){

            	        // creo dei div, nella quale andrò a contenere la domanda è le sue valutazioni

            	          domanda=document.getElementById("Domanda:"+min);
            	          div1=document.createElement("div");
            	          div1.setAttribute("class", "col-5");

            	          div2=document.createElement("div");
            	          div2.setAttribute("class", "card");

            	          div3=document.createElement("div");
            	          div3.setAttribute("class", "card-body");

            	          //inserimento dei div all'interno dei contenitori

            	          divDomandeRisposteContenitore.append(div1);
            	          div1.append(div2);
            	          div2.append(div3);
            	          console.log(domanda);
            	          div3.append(domanda);



            	          if(document.querySelectorAll("idDomanda"+min)!=null){

            	            // vado a prendere la lista di risposta relative alla domanda e la trasforma in un array 

            	              const votiDomanda = Array.from(
            	                  document.querySelectorAll(".idDomanda"+min)
            	                  );

            	                  console.log(votiDomanda);

            	                  // tramite questo ciclo vado a prendere i valori all'interno dell'array
            	                  // essendo delle stringhe le converto in numer
            	                  // da qui ad ogni giro le aggiungo alla somma e verifico il valore a quale voto corrisponde
            	                  // a seconda della corrispondenza vado ad aggiungere al counter +1 

            	              for(i=0;i<votiDomanda.length;i++){
            	                      element=votiDomanda[i];
            	                      element = element.textContent;
            	                      element = +element;
            	                      somma = somma + element;

            	                      if(element==0){
            	                          zero+=1
            	                      }else if(element==1){
            	                          uno+=1;
            	                      }else if(element==2){
            	                          due+=1;
            	                      }else if(element==3){
            	                          tre+=1;
            	                      }else if(element==4){
            	                          quattro+=1;
            	                      }else if(element==5){
            	                          cinque+=1;
            	                      }
            	                    
            	                      b+=1;
            	              }

            	          
            	          // calcolo la media
            	          media= somma/b; 
            	          
            	          //totale voti

            	          // la sparo nel dom    
            	          titoloMedia=document.createElement("h3");
            	          titoloMedia.setAttribute("class", "media mt-2");
            	          if(media>1){
            	          titoloMedia.textContent = media.toFixed(2) +" / 5";
            	          }else{
            	            titoloMedia.textContent = "0 / 5";
            	          }
            	          div3.append(titoloMedia);

            	          // vado a creare un array con all'interno il numero di utenti che ha votato per ogni stella 
            	          ListaValori=[null,uno,due,tre,quattro,cinque];


            	          // creo un div all'interno del quale andrò ad inserire tutte le risposte
            	          contenitoreRisposte=document.createElement("div");
            	          contenitoreRisposte.setAttribute("class","d-flex flex-column");

            	          div3.append(contenitoreRisposte);


            	          //all'interno del for vado a creare le stelle, e ad aggiungerci i valori. Gli do un aspetto estetico tramite boostrap
            	          for(a=1;a<=6;a++){
            	            
            	              contenitoreValutazione=document.createElement("div");
            	              contenitoreValutazione.setAttribute("class","d-flex");
            	              numeroRecensori=document.createElement("span");
            	              numeroRecensori.setAttribute("class", "numeroRecensori numeroRecensoriStelle:"+a);
            	              numeroRecensori.textContent = ListaValori[a];
            	              contenitoreRisposte.append(contenitoreValutazione);
            	              GeneraStellaDomandeRisposte(a);
            	              contenitoreValutazione.append(odv);
            	              contenitoreValutazione.append(numeroRecensori);
            	              console.log(a);

            	          }

            	          }
            	      }

            	      // aumento il counter e min

            	      min+=1;
            	      counter+=1;
            	  }
            	/*  let Tot=0;
            	  let val=0;
            	  let span_totale_voti=document.getElementById("totale_voti");
    	          totale_voti=  document.getElementsByClassName("numero-recensori");
    	          for(i=0;i<totale_voti.lenght;i++){
    	        	  element= totale_voti[i].textContent;
    	        	  val= +element;
    	        	  console.log(element);
    	        	  Tot=Tot+val;*/
    	        	  
    	          }

            	 // span_totale_voti.append(Tot);
            	


            	function GeneraStellaDomandeRisposte(parametro){
            	    
            	                let i=0;

            	                odv = document.createElement('div');
            	                odv.setAttribute("class", "Div-stelle"+parametro);
            	            
            	                while (i<parametro){
            	                    // creo il numero di stelle che mi serve ogni volta che richiamo la funzione
            	                    stella = document.createElement('span');
            	                    stella.setAttribute("class", "fa fa-star checked");
            	                    odv.append(stella);
            	                    i+=1;
            	                }

            	            
            	            }


            	function AttivaForm(id){

            		var input = document.createElement("input");
            		input.type = "text";
            		input.value=id;
            		input.setAttribute("id","idQuestionario");
            		input.setAttribute("name","idQuestionario")
            		//input.className = "css-class-name"; // set the CSS class
            		container = document.getElementById("container-input");
            		container.appendChild(input); // put it into the DOM
            		input.style.display = 'none';

            		$("#attivaQuestionario").submit();

            		};
            		
                	function EliminaForm(id){

                		var input = document.createElement("input");
                		input.type = "number";
                		input.value=id;
                		input.setAttribute("id","idQuestionario");
                		input.setAttribute("name","idQuestionario")
                		//input.className = "css-class-name"; // set the CSS class
                		container = document.getElementById("container-input_1");
                		container.appendChild(input); // put it into the DOM
                		input.style.display = 'none';

                		$("#eliminaQuestionario").submit();

                		};
                		
                        function GeneraMediaTabella(){
                            

                            let media;
                            let somma;
                            let valore;
                            let i;
                            let element;
                            let counter;
                            
                            let Div_media=document.getElementsByClassName("Divmedia");
                        for(i=0;i<Div_media.length;i++){
                        	   media=0;
                               somma=0;
                               valore=0;
                               counter=0
                        	
                            id=Div_media[i].getAttribute('id');
                            console.log(id);
                        
                            let elements = document.getElementsByName("questionarioRelativo:"+id);
                            console.log(elements);
                        for (let b=0;b<elements.length;b++){
                            element = elements[b].textContent;
                                console.log(element)
                                valore= +element;
                                somma+=valore;
                                console.log(somma);
                                counter++
                            }
                            media=parseFloat(somma/counter).toFixed(2);
                            console.log("sono la media:"+ media);
                            var TestoMedia = document.createElement("h5");
                            TestoMedia.textContent=media;    
                            Div_media[i].append(TestoMedia);
                        }   
                        }
            
            // richiamo funzione
            
            console.log(numeroquestionari);
            
            PosizionaDomanda(numeroquestionari);
            
            GeneraStella(5);
            GeneraStella(4);
            GeneraStella(3);
            GeneraStella(2);
            GeneraStella(1);
            
            CreaGrafico();          
            
        	PosizionaDomandaeRisposte();
        	
            GeneraMediaTabella();


            </script> 

            <style>
                .div-stella{
                    display: flex;
                    align-items: center;
                }
                .numero-recensori{
                    padding-left: 10px;
                }

                .checked {
                  color: orange;
                    }

                    
         .NumeroIndiceDomanda{
            display: none;
        }
        
                        .numeroRecensori{
                    padding-left: 10px;
                }
                
                        .Div-stelle6{
          display: none;
        }
        
        #valutazioneDomande{
        display:none};


                .button-attiva {
                  background-color: rgb(64, 125, 3);
                  border-radius: 24px;
                  border-style: none;
                  box-shadow: rgb(0 0 0 / 20%) 0 3px 5px -1px, rgb(0 0 0 / 14%) 0 6px 10px 0, rgb(0 0 0 / 12%) 0 1px 18px 0;
                  box-sizing: border-box;
                  color: #3c4043;
                  cursor: pointer;
                  fill: currentcolor;
                  font-family: inherit;
                  font-size: 14px;
                  font-weight: 500;
                  height: 50px;
                  width: 150px;
                  padding: 2px 24px;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                
                }

                .button-attiva:hover {
                    color: #9518fc;
                }

                .button-elimina {
                  margin-top: 10px;
                  margin-right: 10px;
                  background-color: rgb(229, 27, 27);
                  border-radius: 24px;
                  border-style: none;
                  box-shadow: rgb(0 0 0 / 20%) 0 3px 5px -1px, rgb(0 0 0 / 14%) 0 6px 10px 0, rgb(0 0 0 / 12%) 0 1px 18px 0;
                  box-sizing: border-box;
                  color: #3c4043;
                  cursor: pointer;
                  fill: currentcolor;
                  font-family: inherit;
                  font-size: 14px;
                  font-weight: 500;
                  height: 50px;
                  width: 150px;
                  padding: 2px 24px;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  margin-left: 4px;
                
                }

                .button-elimina:hover {
                    color: #9518fc;
                }
                
                .questionari_id{
                
                display:none;
                }

            </style>

</body>

</html>